#!./tools/vlua

dofile('tools/vmake_base.lua')

CC  = 'gcc'
CXX = 'g++'
AR  = 'ar -rc'
DLL_SUFFIX = '.so'
EXE_SUFFIX = vlua.OS=='windows' and '.exe' or ''
CFLAGS  = {'-Wall'}
CXX_CFLAGS = {}
OBJPATH = path_concat('objs', 'r')

PUSS_INCLUDE_PATH = 'include'
GEN_INCLUDE_PATH = path_concat('objs', 'gen')
PUSS_MODULE_SUFFIX = ''
INCLUDES = { '3rd', PUSS_INCLUDE_PATH, GEN_INCLUDE_PATH }

-- debug && asan
do
	if vlua.match_arg('^%-debug$') then
		array_push(CFLAGS, '-g', '-O0', '-D_DEBUG')
		OBJPATH = path_concat('objs', 'd')
		PUSS_MODULE_SUFFIX = PUSS_MODULE_SUFFIX .. '_d'
	else
		array_push(CFLAGS, '-s', '-O2', '-DNDEBUG')
	end

	if vlua.match_arg('^%-asan$') then
		array_push(CFLAGS, '-ggdb', '-fsanitize=address', '-fno-omit-frame-pointer')
		OBJPATH = OBJPATH .. 'a'
		PUSS_MODULE_SUFFIX = PUSS_MODULE_SUFFIX .. '_asan'
	end
end

-----------------------------
-- common utils

function make_c2objs(srcs, objpath, include_paths, ...)	-- ... is cflags
	if type(srcs)=='string' then srcs = scan_files(srcs, function(f) return f:match('^.+%.c$') end) end
	local cflags = args_concat(...)
	local incs = array_convert(include_paths, function(v) return '-I'..v end)
	return make_objs(srcs, include_paths
		, function(f) return path_concat(objpath or OBJPATH, f) end
		, function(t) return CC, CFLAGS, cflags, incs, '-o', t.obj, '-c', t.src end)
end

function make_cpp2objs(srcs, objpath, include_paths, ...)	-- ... is cflags
	if type(srcs)=='string' then srcs = scan_files(srcs, function(f) return f:match('^.+%.cpp$') or f:match('^.+%.cxx$') end) end
	local cflags = args_concat(...)
	local incs = array_convert(include_paths, function(v) return '-I'..v end)
	return make_objs(srcs, include_paths
		, function(f) return path_concat(objpath or OBJPATH, f) end
		, function(t) return CXX, CFLAGS, CXX_CFLAGS, cflags, incs, '-o', t.obj, '-c', t.src end)
end

vmake_target_add('', function(target)
	local ts = os.time()
	local targets = vmake_target_all()
	targets['clean'] = nil	-- ignore clean
	targets[target] = nil   -- ignore this
	for target in pairs(targets) do
		local ok, err = pcall(vmake, target)
		if not ok then print('vmake', target, 'error:', err) end
	end
	local te = os.time()
	print('use time:', te-ts)
end)

vmake_target_add('clean', function(target)
	local rm = vlua.OS=='windows' and 'rd /S /Q ' or 'rm -rf '
	os.execute(rm .. 'objs')
end)

-----------------------------
-- puss core

vmake_target_add('puss', function(target)
	local slibs = vmake('puss_core', 'lua53')
	local cflags = { '-D_PUSS_MODULE_SUFFIX=\\"'..PUSS_MODULE_SUFFIX..'.so\\"' }
	local incs = array_pack(INCLUDES, 'modules')
	local libs = vlua.OS=='windows' and '' or '-lm -ldl'
	local objs = make_c2objs(target, nil, incs, cflags)
	local output = path_concat('bin', target..PUSS_MODULE_SUFFIX..EXE_SUFFIX)
	return make_target(output, {objs, slibs}, CC, CFLAGS, '-o', output, objs, slibs, libs)
end)

vmake_target_add('luaproxy', function(target)
	local luapath = path_concat('3rd', 'lua-5.3.4', 'src')
	local luaproxy_lua = path_concat('tools', 'luaproxy.lua')
	local deps =
		{ luaproxy_lua
		, make_copy('luaconf.h', PUSS_INCLUDE_PATH, luapath)
		, make_copy('lua.h', PUSS_INCLUDE_PATH, luapath)
		, make_copy('lualib.h', PUSS_INCLUDE_PATH, luapath)
		, make_copy('lauxlib.h', PUSS_INCLUDE_PATH, luapath)
		}
	if check_deps(path_concat(PUSS_INCLUDE_PATH, 'luaproxy.h'), deps)
		and check_deps(path_concat(GEN_INCLUDE_PATH, 'luaproxy.symbols'), deps)
	then
		return
	end

	make_target(path_concat(GEN_INCLUDE_PATH, '.dummy'), nil
		, vlua.self, luaproxy_lua
		, '-path="'..PUSS_INCLUDE_PATH..'"'
		, '-gen="'..GEN_INCLUDE_PATH..'"'
		)
end)

vmake_target_add('lua53', function(target)
	local cflags = vlua.OS=='windows' and '' or '-DLUA_USE_LINUX'
	local luapath = path_concat('3rd', 'lua-5.3.4', 'src')
	local srcs = scan_files(luapath, function(f)
		if f=='lua.c' then return end
		if f=='luac.c' then return end
		return f:match('^.+%.c$')
	end)
	local objs = make_c2objs(srcs, nil, nil, cflags)
	local output = path_concat(OBJPATH, 'lib'..target..'.a')
	return make_target(output, objs, AR, output, objs)
end)

vmake_target_add('puss_core', function(target)
	vmake('luaproxy')

	local luapath = path_concat('3rd', 'lua-5.3.4', 'src')
	local srcpath = path_concat('modules', target)
	vmake('luaproxy')
	make_copy('puss_macros.h', PUSS_INCLUDE_PATH, srcpath)
	make_copy('puss_module.h', PUSS_INCLUDE_PATH, srcpath)

	local incs = array_pack(INCLUDES, luapath)
	local objs = make_c2objs(srcpath, nil, incs)
	local lib = path_concat(OBJPATH, 'lib'..target..'.a')
	return make_target(lib, objs, AR, lib, objs)
end)

vmake_target_add('puss_socket', function(target)
	vmake('puss_core')
	local objs = make_c2objs(path_concat('modules', target), nil, INCLUDES, '-fPIC', '-fvisibility=hidden')
	local output = path_concat('bin', 'modules', target..PUSS_MODULE_SUFFIX..'.so')
	local libs = vlua.OS=='windows' and '-lwsock32' or ''
	return make_target(output, objs, CC, CFLAGS, '-shared', '-o', output, objs, libs)
end)

-----------------------------
-- imgui lua wrapper

vmake_target_add('imgui_wrap', function(target)
	local src = path_concat('modules', 'puss_imgui', 'imgui')
	local imgui_wrap = path_concat('tools', 'imgui_wrap.lua')
	local deps =
		{ imgui_wrap
		, path_concat(src, 'imgui.h')
		, path_concat(src, 'imgui_tabs.h')
		}
	if check_deps(path_concat(GEN_INCLUDE_PATH, 'imgui_enums.inl'), deps)
		and check_deps(path_concat(GEN_INCLUDE_PATH, 'imgui_wraps.inl'), deps)
		and check_deps(path_concat(GEN_INCLUDE_PATH, 'imgui_lua.inl'), deps)
	then
		return
	end

	make_target(path_concat(GEN_INCLUDE_PATH, '.dummy'), nil
		, vlua.self, imgui_wrap
		, '-src='..src
		, '-out='..GEN_INCLUDE_PATH
		)
end)

-----------------------------
-- scintilla iface

SCINTILLA_ROOT_PATH = path_concat('modules', 'puss_imgui', 'scintilla3')
SCINTILLA_INCLUDE_PATH = path_concat(SCINTILLA_ROOT_PATH, 'include')

vmake_target_add('scintilla_iface', function(target)
	make_copy('Scintilla.iface', GEN_INCLUDE_PATH, SCINTILLA_INCLUDE_PATH)

	local scintilla_iface_lua = path_concat('tools', 'scintilla_iface.lua')
	local scintilla_iface = path_concat(GEN_INCLUDE_PATH, 'Scintilla.iface')
	local scintilla_output = path_concat(GEN_INCLUDE_PATH, 'scintilla.iface.inl')
	local deps =
		{ scintilla_iface_lua
		, scintilla_iface
		}
	return make_target( scintilla_output, deps
		, vlua.self, scintilla_iface_lua
		, '-input='..scintilla_iface
		, '-output='..scintilla_output
		)
end)

-----------------------------
-- scintilla

vmake_target_add('scintilla_lib', function(target)
	local cflags = array_pack(CFLAGS, '-fPIC', '-fvisibility=hidden', '-DFOX', '-DSCI_LEXER')
	local incs =
		{ SCINTILLA_INCLUDE_PATH
		, path_concat(SCINTILLA_ROOT_PATH, 'src')
		, path_concat(SCINTILLA_ROOT_PATH, 'lexlib')
		}
	local srcobjs = make_cpp2objs(path_concat(SCINTILLA_ROOT_PATH, 'src'), OBJPATH, incs, cflags)
	local lexlibobjs = make_cpp2objs(path_concat(SCINTILLA_ROOT_PATH, 'lexlib'), OBJPATH, incs, cflags)
	local lexobjs = make_cpp2objs(path_concat(SCINTILLA_ROOT_PATH, 'lexers'), OBJPATH, incs, cflags)
	table.sort(lexobjs)
	local all_objs = { srcobjs, lexlibobjs, lexobjs }
	local lib = path_concat(OBJPATH, 'lib'..target..'.a')
	return make_target(lib, all_objs, AR, lib, all_objs)
end)

-----------------------------
-- puss imgui

vmake_target_add('puss_imgui', function(target)
	vmake('imgui_wrap', 'scintilla_iface')
	local slibs = vmake('scintilla_lib')
	local src = path_concat('modules', target)
	local incs = array_pack(
		{ INCLUDES
		, SCINTILLA_INCLUDE_PATH
		, path_concat(SCINTILLA_ROOT_PATH, 'src')
		, path_concat(SCINTILLA_ROOT_PATH, 'lexlib')
		, src
		, path_concat(src, 'gl3w')
		, path_concat(src, 'imgui')
		})
	local cflags = array_pack(CFLAGS, '-DSCI_LEXER', shell('pkg-config --static --cflags glfw3'))
	local libs = shell('pkg-config --static --libs glfw3')
	if vlua.OS=='windows' then
		libs = array_pack(libs, '-lopengl32')
	else
		libs = array_pack(libs, '-lGL')
	end
	local objs = make_c2objs(src, nil, incs, '-fPIC', '-fvisibility=hidden')
	local cppobjs = make_cpp2objs(src, nil, incs, '-fPIC', '-fvisibility=hidden')
	local output = path_concat('bin', 'modules', target..PUSS_MODULE_SUFFIX..'.so')
	return make_target(output, {objs, cppobjs, slibs}, CXX, cflags, '-shared', '-o', output, objs, cppobjs, slibs, libs)
end)

